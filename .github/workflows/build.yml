name: Build CachyOS ISO

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # The container must be at the job level
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Maximize Build Space
        run: |
          rm -rf /usr/share/dotnet
          rm -rf /usr/local/lib/android
          rm -rf /opt/ghc
          rm -rf "/usr/local/share/boost"
          rm -rf /usr/lib/jvm

      - name: Install Dependencies
        run: |
          # 1. Initialize standard Arch keys
          pacman-key --init
          pacman-key --populate archlinux

          # 2. Setup CachyOS Keyring and Repositories
          # This allows the container to trust CachyOS packages
          pacman -Sy --noconfirm wget
          wget https://mirror.cachyos.org/cachyos-repo.tar.xz
          tar xvf cachyos-repo.tar.xz
          cd cachyos-repo
          ./cachyos-repo.sh
          cd ..

          # 3. Update system and install build tools
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed \
            base-devel \
            archiso \
            mkinitcpio-archiso \
            git \
            squashfs-tools \
            grub \
            efibootmgr \
            libisoburn \
            dosfstools \
            mtools \
            patch \
            sudo

      - name: Prepare Permissions
        run: |
          chmod +x ./buildiso.sh
          if [ -f "./fix_permissions.sh" ]; then
            chmod +x ./fix_permissions.sh
            ./fix_permissions.sh
          fi

      - name: Build ISO
        run: |
          ./buildiso.sh -p desktop -v -w

      - name: Upload ISO Artifact
        uses: actions/upload-artifact@v4
        with:
          name: CachyOS-Desktop-ISO
          path: out/**/*.iso
          if-no-files-found: error
          retention-days: 7
