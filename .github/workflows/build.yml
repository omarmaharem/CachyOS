name: Build CachyOS ISO

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Allows manual triggering

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged # Required for mkarchiso/mount operations
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed base-devel archiso mkinitcpio-archiso git squashfs-tools sudo

      - name: Prepare permissions
        run: |
          # CachyOS build scripts often require a 'fix_permissions' step
          if [ -f "./fix_permissions.sh" ]; then
            chmod +x ./fix_permissions.sh
            ./fix_permissions.sh
          fi
          chmod +x ./buildiso.sh

      - name: Build ISO
        run: |
          # -p desktop: default profile
          # -w: remove build directory after finish
          # -v: verbose logging
          ./buildiso.sh -p desktop -v -w

      - name: Upload ISO Artifact
        uses: actions/upload-artifact@v4
        with:
          name: CachyOS-ISO
          path: out/*.iso
          if-no-files-found: error
