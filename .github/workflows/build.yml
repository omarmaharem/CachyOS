name: Build CachyOS ISO

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Maximize Build Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/lib/jvm
          sudo apt-get clean

      - name: Set up Arch Linux in Docker
        run: |
          docker pull archlinux:latest
          docker run -d --name archiso-builder \
            --privileged \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            archlinux:latest \
            tail -f /dev/null

      - name: Build ISO in Container
        run: |
          docker exec archiso-builder bash -c '
            # Initialize keys
            pacman-key --init
            pacman-key --populate archlinux
            
            # Setup CachyOS
            pacman -Sy --noconfirm wget
            wget https://mirror.cachyos.org/cachyos-repo.tar.xz
            tar xvf cachyos-repo.tar.xz
            cd cachyos-repo
            ./cachyos-repo.sh
            cd ..
            
            # Install dependencies
            pacman -Syu --noconfirm
            pacman -S --noconfirm --needed \
              base-devel archiso mkinitcpio-archiso git \
              squashfs-tools grub efibootmgr libisoburn \
              dosfstools mtools patch sudo
            
            # Build
            chmod +x ./buildiso.sh
            ./buildiso.sh -p desktop -v -w
          '

      - name: Copy ISO from Container
        run: |
          docker cp archiso-builder:/workspace/out ./out

      - name: Upload ISO Artifact
        uses: actions/upload-artifact@v4
        with:
          name: CachyOS-Desktop-ISO
          path: out/**/*.iso
          if-no-files-found: error
          retention-days: 7
