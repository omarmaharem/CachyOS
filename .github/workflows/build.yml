name: Build CachyOS ISO

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Maximize Build Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/lib/jvm
          sudo apt-get clean
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Cache Pacman packages
        uses: actions/cache@v4
        with:
          path: ./pacman-cache
          key: ${{ runner.os }}-pacman-${{ hashFiles('.github/workflows/build.yml') }}-v2
          restore-keys: |
            ${{ runner.os }}-pacman-

      - name: Cache ccache (5GB)
        uses: actions/cache@v4
        with:
          path: ./ccache
          key: ${{ runner.os }}-ccache-5gb-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-5gb-

      - name: Cache CachyOS repo
        uses: actions/cache@v4
        with:
          path: ./cachyos-repo.tar.xz
          key: ${{ runner.os }}-cachyos-repo-${{ hashFiles('.github/workflows/build.yml') }}
          restore-keys: |
            ${{ runner.os }}-cachyos-repo-

      - name: Set up Arch Linux in Docker
        run: |
          docker pull archlinux:latest
          mkdir -p ./pacman-cache ./ccache
          docker run -d --name archiso-builder \
            --privileged \
            -v ${{ github.workspace }}:/workspace \
            -v ${{ github.workspace }}/pacman-cache:/var/cache/pacman/pkg \
            -v ${{ github.workspace }}/ccache:/root/.ccache \
            -w /workspace \
            -e DEBIAN_FRONTEND=noninteractive \
            archlinux:latest \
            tail -f /dev/null

      - name: Build ISO in Container
        run: |
          docker exec archiso-builder bash -c '
            set -e
            
            # Disable interactive prompts completely
            export DEBIAN_FRONTEND=noninteractive
            
            # Configure pacman to never ask for confirmation
            sed -i "s/#Color/Color\nILoveCandy\nNoProgressBar/" /etc/pacman.conf
            
            echo "=== Checking Available Space ==="
            df -h
            
            echo "=== Initializing Pacman Keys ==="
            pacman-key --init
            pacman-key --populate archlinux
            
            echo "=== Setting up CachyOS Repository ==="
            if [ ! -f "cachyos-repo.tar.xz" ]; then
              echo "Downloading CachyOS repo (not cached)..."
              pacman -Sy --noconfirm --needed wget
              wget https://mirror.cachyos.org/cachyos-repo.tar.xz
            else
              echo "Using cached CachyOS repo..."
              pacman -Sy --noconfirm --needed wget
            fi
            
            tar xvf cachyos-repo.tar.xz
            cd cachyos-repo
            
            # Run the CachyOS repo setup script non-interactively
            yes | ./cachyos-repo.sh || ./cachyos-repo.sh --noconfirm || true
            cd ..
            
            echo "=== Updating System (this may take a while) ==="
            # Use yes to pipe confirmations, but with timeout as backup
            yes | timeout 600 pacman -Syu --noconfirm --needed || pacman -Syu --noconfirm --needed
            
            echo "=== Installing Dependencies ==="
            pacman -S --noconfirm --needed \
              base-devel \
              archiso \
              mkinitcpio-archiso \
              git \
              squashfs-tools \
              grub \
              efibootmgr \
              libisoburn \
              dosfstools \
              mtools \
              patch \
              sudo \
              ccache
            
            echo "=== Configuring ccache (5GB) ==="
            export PATH="/usr/lib/ccache/bin:$PATH"
